// 1. Conexão com o banco
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 2. Geração do client
generator client {
  provider = "prisma-client-js"
}

//
// ===== Enums =====
//

enum StatusLicitacaoDetalhada {
  EM_ANDAMENTO
  VENCIDA
  ENCERRADA
  DESCLASSIFICADA
}

enum Role {
  ADMIN
  OPERACIONAL
}

//
// ===== MODELS EXISTENTES =====
//

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  name         String
  role         Role     @default(OPERACIONAL)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("users")
}

model LicitacaoDetalhada {
  id               String                   @id @default(cuid())
  city             String
  bidNumber        String
  realizationDate  String
  placement        String
  status           StatusLicitacaoDetalhada
  companyName      String
  platformLink     String
  lastUpdated      DateTime                 @updatedAt
  progressForecast String?

  @@map("licitacoes_detalhadas")
}

// ========================================================
// AQUI ESTAVA O ERRO: FALTAVAM OS CAMPOS NOVOS
// ========================================================
model EventoCalendarioDetalhado {
  id                  String  @id @default(cuid())
  start               String
  title               String
  city                String
  bid_number          String
  time                String?
  location            String?
  description         String?
  documentationStatus String? @default("PENDENTE")

  // --- NOVOS CAMPOS QUE FALTAVAM ---
  estimatedValue String? // <--- NOVO
  distance       String? // <--- NOVO
  avgEmployees   String? // <--- NOVO
  warranty       String? // <--- NOVO
  editalFile     String? @db.Text // <--- NOVO (Para o PDF Base64)
  editalFileName String? // <--- NOVO

  @@map("eventos_calendario")
}

model Municipio {
  id      String   @id @default(cuid())
  nome    String   @unique
  editais Edital[]

  @@map("municipios")
}

model Edital {
  id          String        @id @default(cuid())
  nome        String
  itens       EstoqueItem[]
  saidas      SaidaItem[]
  empenhos    Empenho[]
  municipio   Municipio     @relation(fields: [municipioId], references: [id], onDelete: Cascade)
  municipioId String

  @@map("editais")
}

model EstoqueItem {
  id            String  @id @default(cuid())
  descricao     String
  marca         String?
  unidade       String
  quantidade    Float
  valorUnitario Float
  valorTotal    Float
  edital        Edital  @relation(fields: [editalId], references: [id], onDelete: Cascade)
  editalId      String

  @@map("estoque_itens")
}

model SaidaItem {
  id            String  @id @default(cuid())
  itemIndex     Int
  descricao     String
  marca         String?
  quantidade    Float
  valorUnitario Float
  valorTotal    Float
  data          String
  notaFiscal    String
  edital        Edital  @relation(fields: [editalId], references: [id], onDelete: Cascade)
  editalId      String

  @@map("saidas_itens")
}

model Empenho {
  id              String  @id @default(cuid())
  dataPedido      String
  numeroPedido    String
  numeroProcesso  String
  dataNotaFiscal  String?
  valorNotaFiscal Float?
  empenhoPDF      Json?
  notaFiscalPDF   Json?
  edital          Edital  @relation(fields: [editalId], references: [id], onDelete: Cascade)
  editalId        String
  statusPagamento String? @default("PENDENTE")
  dataPagamento   String?

  @@map("empenhos")
}

model SimulacaoSalva {
  id        String          @id @default(cuid())
  data      DateTime        @default(now())
  municipio String
  edital    String
  itens     SimulacaoItem[]

  @@map("simulacoes_salvas")
}

model SimulacaoItem {
  id            Int            @id @default(autoincrement())
  itemIndex     Int
  descricao     String
  marca         String?
  unidade       String
  quantidade    Float
  valorUnitario Float
  valorTotal    Float
  simulacao     SimulacaoSalva @relation(fields: [simulacaoId], references: [id], onDelete: Cascade)
  simulacaoId   String

  @@map("simulacoes_itens")
}

model EPIEntrega {
  id          String @id @default(cuid())
  funcionario String
  item        String
  quantidade  Int
  dataEntrega String

  @@map("epi_entregas")
}

model EPIEstoqueItem {
  id           String  @id @default(cuid())
  name         String  @unique
  qty          Int     @default(0)
  manualOut    Boolean @default(false)
  manualOutQty Int     @default(0)

  @@map("epi_estoque_itens")
}

model Cotacao {
  id    String        @id @default(cuid())
  local String
  data  String
  itens CotacaoItem[]

  @@map("cotacoes")
}

model CotacaoItem {
  id            String  @id @default(cuid())
  produto       String
  unidade       String
  quantidade    Float
  valorUnitario Float
  valorTotal    Float
  marca         String?
  cotacao       Cotacao @relation(fields: [cotacaoId], references: [id], onDelete: Cascade)
  cotacaoId     String

  @@map("cotacao_itens")
}

model ValorReferencia {
  id      String @id
  produto String
  valor   Float

  @@map("valores_referencia")
}

model SimulacaoCotacaoSalva {
  id    String                 @id @default(cuid())
  nome  String
  data  DateTime               @default(now())
  itens SimulacaoCotacaoItem[]

  @@map("simulacoes_cotacoes_salvas")
}

model SimulacaoCotacaoItem {
  id                 Int                   @id @default(autoincrement())
  produto            String
  unidade            String
  quantidade         Float
  valorUnitario      Float
  valorTotal         Float
  marca              String?
  origemCotacaoId    String
  origemCotacaoLocal String
  origemCotacaoData  String
  simulacao          SimulacaoCotacaoSalva @relation(fields: [simulacaoId], references: [id], onDelete: Cascade)
  simulacaoId        String

  @@map("simulacoes_cotacoes_itens")
}

model CalculadoraSalva {
  id     String   @id @default(cuid())
  nome   String
  data   DateTime @default(now())
  custos Json

  @@map("calculadora_salva")
}

//
// ===== NOVOS MODELS: EMISSOR DE NFE =====
//

model NfeEmitente {
  id                String   @id @default(cuid())
  cnpj              String   @unique
  razaoSocial       String
  inscricaoEstadual String?
  email             String?
  crt               String? // 1=Simples, 3=Normal
  endereco          Json // { logradouro, numero, bairro, municipio, uf, cep, codigoIbge }
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("nfe_emitentes")
}

model NfeDestinatario {
  id                String   @id @default(cuid())
  cnpj              String // Não é unique pois pode haver filiais ou repetição em contextos diferentes
  razaoSocial       String
  inscricaoEstadual String?
  email             String?
  endereco          Json // { logradouro, numero, bairro, municipio, uf, cep, codigoIbge }
  createdAt         DateTime @default(now())

  @@map("nfe_destinatarios")
}

model NfeProduto {
  id            String   @id @default(cuid())
  codigo        String
  descricao     String
  ncm           String
  cfop          String
  unidade       String
  valorUnitario Float
  gtin          String?
  tax           Json // { origem, cst, aliquotas... }
  createdAt     DateTime @default(now())

  @@map("nfe_produtos")
}

model NfeDocumento {
  id          String   @id @default(cuid())
  numero      String
  serie       String
  chaveAcesso String?
  status      String // draft, authorized, cancelled, error
  xmlAssinado String?  @db.Text
  dataEmissao DateTime @default(now())
  protocoloAutorizacao String?

  // Armazena o snapshot completo da nota
  fullData Json

  // Relacionamento opcional para saber qual empresa emitiu
  emitenteCnpj String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("nfe_documentos")
}

//
// ===== CONFIGURAÇÕES GLOBAIS =====
//

model SystemSettings {
  id         String  @id // Usaremos um ID fixo como 'global'
  nfeEnabled Boolean @default(true)

  @@map("system_settings")
}

